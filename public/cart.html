<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Responsive Bootstrap4 Shop Template, Created by Imran Hossain from https://imransdesign.com/"
    />

    <!-- title -->
    <title>Cart</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- favicon -->
    <link rel="shortcut icon" type="image/png" href="assets/img/favicon.png" />
    <!-- google font -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap"
      rel="stylesheet"
    />
    <!-- fontawesome -->
    <link rel="stylesheet" href="assets/css/all.min.css" />
    <!-- bootstrap -->
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css" />
    <!-- owl carousel -->
    <link rel="stylesheet" href="assets/css/owl.carousel.css" />
    <!-- magnific popup -->
    <link rel="stylesheet" href="assets/css/magnific-popup.css" />
    <!-- animate css -->
    <link rel="stylesheet" href="assets/css/animate.css" />
    <!-- mean menu css -->
    <link rel="stylesheet" href="assets/css/meanmenu.min.css" />
    <!-- main style -->
    <link rel="stylesheet" href="assets/css/main.css" />
    <!-- responsive -->
    <link rel="stylesheet" href="assets/css/responsive.css" />
  </head>
  <body>
    <!--PreLoader-->
    <div class="loader">
      <div class="loader-inner">
        <div class="circle"></div>
      </div>
    </div>
    <!--PreLoader Ends-->

    <!-- header -->
    <div class="top-header-area" id="sticker">
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-sm-12 text-center">
            <div class="main-menu-wrap">
              <!-- logo -->
              <div class="site-logo">
                <a href="index.html">
                  <img src="assets/img/logo.png" alt="" />
                </a>
              </div>
              <!-- logo -->

              <!-- menu start -->
              <nav class="main-menu">
                <ul>
                  <li class="current-list-item">
                    <a href="#">Home</a>
                    <ul class="sub-menu">
                      <li><a href="index.html">Static Home</a></li>
                      <li><a href="index_2.html">Slider Home</a></li>
                    </ul>
                  </li>
                  <li><a href="about.html">About</a></li>
                  <li>
                    <a href="#">Pages</a>
                    <ul class="sub-menu">
                      <li><a href="404.html">404 page</a></li>
                      <li><a href="about.html">About</a></li>
                      <li><a href="cart.html">Cart</a></li>
                      <li><a href="checkout.html">Check Out</a></li>
                      <li><a href="contact.html">Contact</a></li>
                      <li><a href="news.html">News</a></li>
                      <li><a href="shop.html">Shop</a></li>
                    </ul>
                  </li>
                  <li>
                    <a href="news.html">News</a>
                    <ul class="sub-menu">
                      <li><a href="news.html">News</a></li>
                      <li><a href="single-news.html">Single News</a></li>
                    </ul>
                  </li>
                  <li><a href="contact.html">Contact</a></li>
                  <li>
                    <a href="shop.html">Shop</a>
                    <ul class="sub-menu">
                      <li><a href="shop.html">Shop</a></li>
                      <li><a href="checkout.html">Check Out</a></li>
                      <li><a href="single-product.html">Single Product</a></li>
                      <li><a href="cart.html">Cart</a></li>
                    </ul>
                  </li>
                  <li>
                    <div class="header-icons">
                      <a class="shopping-cart" href="cart.html"
                        ><i class="fas fa-shopping-cart"></i
                      ></a>
                      <a class="mobile-hide search-bar-icon" href="#"
                        ><i class="fas fa-search"></i
                      ></a>
                    </div>
                  </li>
                </ul>
              </nav>
              <a class="mobile-show search-bar-icon" href="#"
                ><i class="fas fa-search"></i
              ></a>
              <div class="mobile-menu"></div>
              <!-- menu end -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end header -->

    <!-- search area -->
    <div class="search-area">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <span class="close-btn"><i class="fas fa-window-close"></i></span>
            <div class="search-bar">
              <div class="search-bar-tablecell">
                <h3>Search For:</h3>
                <input type="text" placeholder="Keywords" />
                <button type="submit">
                  Search <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end search arewa -->

    <!-- breadcrumb-section -->
    <div class="breadcrumb-section breadcrumb-bg">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 offset-lg-2 text-center">
            <div class="breadcrumb-text">
              <p>Fresh and Organic</p>
              <h1>Cart</h1>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end breadcrumb section -->

    <!-- cart -->
    <div class="cart-section mt-150 mb-150">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-12">
            <div class="cart-table-wrap">
              <table class="cart-table">
                <thead class="cart-table-head">
                  <tr class="table-head-row">
                    <th class="product-remove"></th>
                    <th class="product-image">Product Image</th>
                    <th class="product-name">Name</th>
                    <th class="product-price">Price</th>
                    <th class="product-quantity">Quantity</th>
                    <th class="product-total">Total</th>
                  </tr>
                </thead>
                <tbody id="carttable">
                  <tr class="table-body-row">
                    <td class="product-remove">
                      <a href="#"><i class="far fa-window-close"></i></a>
                    </td>
                    <td class="product-image">
                      <img src="assets/img/products/product-img-1.jpg" alt="" />
                    </td>
                    <td class="product-name">Tên sách(name)</td>
                    <td class="product-price">Price</td>
                    <td class="product-quantity">
                      <input
                        type="number"
                        name="quantity"
                        value=""
                        placeholder="0"
                      />
                    </td>
                    <td class="product-total">quantity*value</td>
                  </tr>
                  <tr class="table-body-row">
                    <td class="product-remove">
                      <a href="#"><i class="far fa-window-close"></i></a>
                    </td>
                    <td class="product-image">
                      <img src="assets/img/products/product-img-2.jpg" alt="" />
                    </td>
                    <td class="product-name">Berry</td>
                    <td class="product-price">$70</td>
                    <td class="product-quantity">
                      <input type="number" placeholder="0" />
                    </td>
                    <td class="product-total">1</td>
                  </tr>
                  <tr class="table-body-row">
                    <td class="product-remove">
                      <a href="#"><i class="far fa-window-close"></i></a>
                    </td>
                    <td class="product-image">
                      <img src="assets/img/products/product-img-3.jpg" alt="" />
                    </td>
                    <td class="product-name">Lemon</td>
                    <td class="product-price">$35</td>
                    <td class="product-quantity">
                      <input type="number" placeholder="0" />
                    </td>
                    <td class="product-total">1</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="total-section">
              <table class="total-table">
                <thead class="total-table-head">
                  <tr class="table-total-row">
                    <th>Total</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="total-data">
                    <td><strong>Total: </strong></td>
                    <td id="cartTotal">$545</td>
                  </tr>
                </tbody>
              </table>

              <div class="cart-buttons">
                <form id="formOrder">
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="name">Người nhận</label>
                      <input
                        type="text"
                        class="form-control"
                        id="name"
                        name="name"
                        placeholder="Người nhận hàng"
                      />
                    </div>
                    <div class="form-group col-md-6">
                      <label for="phone">Điện thoại</label>
                      <input
                        type="text"
                        class="form-control"
                        id="phone"
                        name="phone"
                        placeholder="Số điện thoại"
                      />
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="address">Address</label>
                    <input
                      type="text"
                      class="form-control"
                      id="address"
                      name="address"
                      placeholder="Địa chỉ nhận hàng"
                    />
                  </div>
                  <a onclick="checkout()" class="boxed-btn black">Check Out</a>
                  <a onclick="updateCart()" class="boxed-btn">Update Cart</a>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end cart -->
    <!-- logo carousel -->
    <div class="logo-carousel-section">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="logo-carousel-inner">
              <div class="single-logo-item">
                <img src="assets/img/company-logos/1.png" alt="" />
              </div>
              <div class="single-logo-item">
                <img src="assets/img/company-logos/2.png" alt="" />
              </div>
              <div class="single-logo-item">
                <img src="assets/img/company-logos/3.png" alt="" />
              </div>
              <div class="single-logo-item">
                <img src="assets/img/company-logos/4.png" alt="" />
              </div>
              <div class="single-logo-item">
                <img src="assets/img/company-logos/5.png" alt="" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end logo carousel -->
    <!-- jquery -->
    <script src="assets/js/jquery-1.11.3.min.js"></script>
    <!-- bootstrap -->
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <!-- count down -->
    <script src="assets/js/jquery.countdown.js"></script>
    <!-- isotope -->
    <script src="assets/js/jquery.isotope-3.0.6.min.js"></script>
    <!-- waypoints -->
    <script src="assets/js/waypoints.js"></script>
    <!-- owl carousel -->
    <script src="assets/js/owl.carousel.min.js"></script>
    <!-- magnific popup -->
    <script src="assets/js/jquery.magnific-popup.min.js"></script>
    <!-- mean menu -->
    <script src="assets/js/jquery.meanmenu.min.js"></script>
    <!-- sticker js -->
    <script src="assets/js/sticker.js"></script>
    <!-- main js -->
    <script src="assets/js/main.js"></script>
    <script type="text/javascript">
      var cartTotal = 0;
      const requestData = {};
      const updateData = {};
      updateData.books = [];
      requestData.books = [];

      function getCookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
      }
      var token = getCookie("jwtToken");
      $(document).ready(function () {
        $.ajax({
          url: "http://localhost:3000/cart",
          type: "GET",
          beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Bearer " + token);
          },
          success: function (response) {
            $(".table-body-row").remove();
            console.log(response);

            response.forEach(function (cartItem) {
              var tmpBook = {};
              tmpBook = {
                bookId: cartItem.bookId._id,
                quantity: cartItem.quantity,
              };
              requestData.books.push(tmpBook);

              var tmpBookUpdate = {};
              tmpBookUpdate = {
                bookId: cartItem.bookId._id,
                quantity: cartItem.quantity,
              };
              updateData.books.push(tmpBookUpdate);

              var totalItem = cartItem.quantity * cartItem.bookId.price;
              cartTotal += totalItem;
              var productRemove =
                '<td class="product-remove"><a href="#" class="remove-item" data-item-id="' +
                cartItem.bookId._id +
                '"><i class="far fa-window-close"></i></a></td>';
              var productImage =
                '<td class="product-image"><img src="assets/img/products/product-img-1.jpg" alt="" /></td>';
              var productName =
                '<td class="product-name">' + cartItem.bookId.name + "</td>";
              var productPrice =
                '<td class="product-price">' + cartItem.bookId.price + "</td>";
              var productQuantity =
                '<td class="product-quantity"><input type="number" min=1 name="quantity" id="quantity' +
                cartItem.bookId._id +
                '" value="' +
                cartItem.quantity +
                '" placeholder="0" /></td>';
              var productTotal =
                '<td class="product-total">' + totalItem + "</td>";

              var newRow =
                '<tr class="table-body-row" data-item-id="' +
                cartItem.bookId._id +
                '">' +
                productRemove +
                productImage +
                productName +
                productPrice +
                productQuantity +
                productTotal +
                "</tr>";

              $("#carttable").append(newRow);
              document.getElementById("cartTotal").innerHTML =
                cartTotal + " vnd";
            });
            $("#carttable").on("click", ".remove-item", function (event) {
              event.preventDefault();
              var itemId = $(this).data("item-id");
              deleteCartItem(itemId);
            });
          },
          error: function (jqXHR, exception) {
            console.log(jqXHR);
            console.log(exception);
          },
        });

        // Hàm xử lý gọi API delete
        function deleteCartItem(itemId) {
          $.ajax({
            url: "http://localhost:3000/cart/delete-item/" + itemId,
            type: "DELETE",
            beforeSend: function (xhr) {
              xhr.setRequestHeader("Authorization", "Bearer " + token);
            },
            success: function (response) {
              console.log(response);
              $('.table-body-row[data-item-id="' + itemId + '"]').remove();
              alert("Xoá khỏi giỏ hàng thành công");

            },
            error: function (xhr, status, error) {
              console.error(xhr.responseText);
              alert("Đã xảy ra lỗi khi xoá mục khỏi giỏ hàng.");
            },
          });
        }
      });

      function checkout() {
        const name = document.getElementById("name").value;
        requestData.name = name;

        const address = document.getElementById("address").value;
        requestData.address = address;

        const phone = document.getElementById("phone").value;
        requestData.phone = phone;

        requestData.totalPrice = cartTotal;
        console.log(JSON.stringify(requestData));
        $.ajax({
          url: "http://localhost:3000/orders/create-order",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(requestData),
          beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Bearer " + token);
          },
          success: function (response) {
            // Xử lý phản hồi từ API
            console.log("Đơn hàng đã được tạo:", response);
            alert(
              "Thanh toán thành công, đơn hàng của bạn sẽ được gửi đi sớm!"
            );
            window.location.href = "http://127.0.0.1:5500/public/shop.html";
          },
          error: function (xhr, status, error) {
            // Xử lý lỗi nếu có
            console.error("Lỗi khi tạo đơn hàng:", error);
          },
        });
      }
      function updateCart() {
        updateData.books.forEach(async (object) => {
          const id = "quantity"+ object.bookId;
          const updatedQuantity = document.getElementById(id).value;

          if (parseInt(updatedQuantity)!==parseInt(object.quantity)) {
            object.quantity = updatedQuantity;
          }
        });
        console.log(JSON.stringify(updateData));
      
        $.ajax({
          url: "http://localhost:3000/cart/update-cart",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(updateData),
          beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Bearer " + token);
          },
          success: function (response) {
            console.log("Sửa thành công giỏ hàng:", response);
            alert("Sửa thành công giỏ hàng!");
          },
          error: function (xhr, status, error) {
            // Xử lý lỗi nếu có
            console.error("Lỗi khi sửa giỏ hàng:", error);
          },
        });
      }
    </script>
  </body>
</html>
